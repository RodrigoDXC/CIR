<?xml version="1.0" encoding="UTF-8"?><record_update table="sp_widget">
    <sp_widget action="INSERT_OR_UPDATE">
        <category>custom</category>
        <client_script><![CDATA[function() {
  /* widget controller */
  var c = this;
}]]></client_script>
        <controller_as>c</controller_as>
        <css/>
        <data_table>sp_instance</data_table>
        <demo_data/>
        <description>Widget used for the location menu on the CIR CIRI Portal</description>
        <docs/>
        <field_list/>
        <has_preview>false</has_preview>
        <id>cir-ciri-location-menu</id>
        <internal>false</internal>
        <link><![CDATA[function link(scope, element, attrs, controller) {
  
}]]></link>
        <name>CIR CIRI Location Menu</name>
        <option_schema/>
        <public>false</public>
        <roles>x_fru_cir.expert,x_fru_cir.investigator</roles>
        <script><![CDATA[(function() {
	/* populate the 'data' object */
	/* e.g., data.table = $sp.getValue('table'); */
	if(options.locationID)
		data.locationID = options.locationID;
	else{
		data.locationID = $sp.getParameter('location_id');
	}
	var items = [];
	items.push({
		href: '?id=cir_ciri_location_overview&location_id=' + data.locationID,
		label:  gs.getMessage('cir_location_overview')
	});
	
	var openCases = 0;
	var openCaseAgg = new GlideAggregate(CIRConstants.Tables.CASE);
	openCaseAgg.addQuery('active=true^location=' + data.locationID);
	openCaseAgg.addAggregate('COUNT');
	openCaseAgg.query();
	if(openCaseAgg.next()){
		openCases = parseInt(openCaseAgg.getAggregate('COUNT'));
	}
	items.push({
		href: '?id=cir_ciri_list&table=' + CIRConstants.Tables.CASE + '&filter=active=true^location=' + data.locationID +"&location_id=" + data.locationID,
		label:  gs.getMessage('cir_open_cases'),
		badge: openCases
	});

	
	if(gs.hasRole('x_fru_cir.investigator')) {
		var openInvestigations = 0;
		var openInvestigationAgg = new GlideAggregate(CIRConstants.Tables.INVESTIGATION);
		openInvestigationAgg.addQuery('active=true^cir_case.location=' + data.locationID);
		openInvestigationAgg.addAggregate('COUNT');
		openInvestigationAgg.query();
		if(openInvestigationAgg.next()){
			openInvestigations = parseInt(openInvestigationAgg.getAggregate('COUNT'));
		}
		items.push({
			href: '?id=cir_ciri_list&table=' + CIRConstants.Tables.INVESTIGATION + '&filter=active=true^cir_case.location=' + data.locationID + '&location_id=' + data.locationID,
			label:  gs.getMessage('cir_open_investigations'),
			badge: openInvestigations
		});
	}
	
	data.items = items;
})();]]></script>
        <servicenow>false</servicenow>
        <sys_class_name>sp_widget</sys_class_name>
        <sys_created_by>Jorge.Diogo@fruitionpartners.pt</sys_created_by>
        <sys_created_on>2020-06-29 08:27:13</sys_created_on>
        <sys_id>903354841b31101024c896ce0a4bcbe9</sys_id>
        <sys_mod_count>2</sys_mod_count>
        <sys_name>CIR CIRI Location Menu</sys_name>
        <sys_package display_value="Corporate Incident Response" source="x_fru_cir">265c101f13ab44100b8670a76144b0a2</sys_package>
        <sys_policy/>
        <sys_scope display_value="Corporate Incident Response">265c101f13ab44100b8670a76144b0a2</sys_scope>
        <sys_update_name>sp_widget_903354841b31101024c896ce0a4bcbe9</sys_update_name>
        <sys_updated_by>Jorge.Diogo@fruitionpartners.pt</sys_updated_by>
        <sys_updated_on>2020-08-24 15:51:24</sys_updated_on>
        <template><![CDATA[<div style="width:100%" class="navbar-inverse" ng-if="data.locationID">
  <ul class="nav navbar-nav navbar-inverse" style="width:100%">
    <li ng-repeat="item in data.items" ng-class="{dropdown: item.items.length > 0}" style="margin-top:-8px">
      <a ng-href="{{item.href}}">{{ item.label }}
        <span ng-if="item.badge != ''" class="label label-as-badge label-primary sp-navbar-badge-count">{{item.badge}}</span>
      </a>
    </li>
  </ul>
</div>]]></template>
    </sp_widget>
</record_update>
