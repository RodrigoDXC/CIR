<?xml version="1.0" encoding="UTF-8"?><record_update table="sp_widget">
    <sp_widget action="INSERT_OR_UPDATE">
        <category>custom</category>
        <client_script><![CDATA[function($scope) {
	/* widget controller */
	var c = this;

	$scope.addMarker = function(event){
		var position = jQuery('#locationImage').position();
		var positionX = position.left + event.offsetX - 5;
		var positionY = position.top + event.offsetY - 5;
		var table = $scope.data.recordType;
		var color = 'red';
		if(table == 'x_fru_cir_hazard')
			color = 'purple';
		else if(table == 'x_fru_cir_near_miss')
			color = 'goldenrod';
		jQuery('.case').remove();
		jQuery('#coordinates').val((positionX + 5) + ',' + (positionY + 20));
		jQuery("#caseContainer").append('<i class="fa fa-circle case" style="left:' + positionX + 'px;top:' + positionY + 'px;z-index:100;color: '+ color + '"></i>');
	};

	$scope.addCase = function(){  
		var coordinates = jQuery('#coordinates').val();
		if(coordinates){
			c.server.get({coordinates:coordinates, data: $scope.data}).then(function(){
				window.history.back();
			});
		}
		else{
			window.history.back();
		}
	};
}]]></client_script>
        <controller_as>c</controller_as>
        <css>.case{&#13;
  color: red;&#13;
  position: absolute;&#13;
  width: 10px;&#13;
}</css>
        <data_table>sp_instance</data_table>
        <demo_data/>
        <description/>
        <docs/>
        <field_list/>
        <has_preview>false</has_preview>
        <id>cir-ciri-case-location</id>
        <internal>false</internal>
        <link><![CDATA[function link(scope, element, attrs, controller) {
  
}]]></link>
        <name>CIR CIRI Case Location</name>
        <option_schema/>
        <public>false</public>
        <roles>x_fru_cir.user</roles>
        <script><![CDATA[(function() {
    /* populate the 'data' object */
    /* e.g., data.table = $sp.getValue('table'); */

    if(input) {
        data = input.data;
        var caseRecord = new GlideRecordSecure(CIRConstants.Tables.CASE);
        if(caseRecord.get(data.recordSys)) {
            caseRecord.coordinates = input.coordinates;
            caseRecord.update();
        }
    } else {
        data.recordType = $sp.getParameter('table');
        data.recordSys = $sp.getParameter('sys_id');
        var record = new GlideRecordSecure(data.recordType);
        if(record.get(data.recordSys)) {
            var cirCaseManagementUtils = new CIRCaseManagementUtils();
            data.caseLocations = new global.JSON().decode(cirCaseManagementUtils.GetCaseLocations(data.recordSys, record.location
                .sys_id));
            data.locationMap = cirCaseManagementUtils.GetLocationMap(record.location.sys_id);
        }
    }
})();]]></script>
        <servicenow>false</servicenow>
        <sys_class_name>sp_widget</sys_class_name>
        <sys_created_by>Jorge.Diogo@fruitionpartners.pt</sys_created_by>
        <sys_created_on>2020-06-26 09:27:12</sys_created_on>
        <sys_id>ff74c94b1b61101024c896ce0a4bcb46</sys_id>
        <sys_mod_count>3</sys_mod_count>
        <sys_name>CIR CIRI Case Location</sys_name>
        <sys_package display_value="Corporate Incident Response" source="x_fru_cir">265c101f13ab44100b8670a76144b0a2</sys_package>
        <sys_policy/>
        <sys_scope display_value="Corporate Incident Response">265c101f13ab44100b8670a76144b0a2</sys_scope>
        <sys_update_name>sp_widget_ff74c94b1b61101024c896ce0a4bcb46</sys_update_name>
        <sys_updated_by>hugo.reis</sys_updated_by>
        <sys_updated_on>2020-12-04 09:37:06</sys_updated_on>
        <template><![CDATA[<div ng-if="data.locationMap">
  <input type="hidden" id="coordinates" value=""/>
  <div id="imageContainer" style="z-index:-1">
    <img id="locationImage" src="{{data.locationMap}}" style="z-index:10;" ng-click="addMarker($event)"/>
    <div id="caseContainer" style="text-align:center;background:transparent;z-index:1">
      <i ng-repeat="location in data.caseLocations" class="fa fa-circle case" 
         style="left:{{location.x}}px;top:{{location.y-20}}px;width:{{location.width}}px;height:{{location.height}}px;
                font-size:{{location.font_size}};color:{{location.color}}" 
         title="{{location.label}}"></i>
    </div>
  </div>
  <div>
    <button type="button" class="btn" style="margin-top:20px" onclick="window.history.back();">${cancel}</button>
    <button type="button" class="btn btn-primary" style="margin-top:20px" ng-click="addCase()">${add_location}</button>
  </div>
</div>]]></template>
    </sp_widget>
</record_update>
