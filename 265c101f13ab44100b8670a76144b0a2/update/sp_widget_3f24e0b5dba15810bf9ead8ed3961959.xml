<?xml version="1.0" encoding="UTF-8"?><record_update table="sp_widget">
    <sp_widget action="INSERT_OR_UPDATE">
        <category>custom</category>
        <client_script><![CDATA[function($scope, spUtil, $uibModal, $rootScope, $location, $timeout, $window) {
    var c = this;

    $scope.hideItemWidget = !$scope.data.category_id;
    if ($scope.data.category) {
        if (!$scope.data.categories)
            $scope.data.categories = [];
        $scope.data.categories.forEach(function(category, index, categories) {
            categories[index].url = category.url + '&catalog_id=' + $scope.data.catalog_id;
        });
        if ($scope.data.sc_catalog)
            $scope.data.categories.unshift({
                label: $scope.data.sc_catalog,
                url: '?id=' + $scope.data.sc_category_page + '&catalog_id=' + $scope.data.catalog_id
            });
        if ($scope.data.show_popular_item) {
            if ($scope.data.all_catalog_msg)
                $scope.data.categories.unshift({
                    label: $scope.data.all_catalog_msg,
                    url: '?id=' + $scope.data.sc_category_page + '&catalog_id=-1'
                });
            else
                $scope.data.categories.push({
                    label: $scope.data.all_cat_msg,
                    url: '#'
                });
        } else {
            if ($scope.data.all_catalog_msg) {
                $scope.data.categories.unshift({
                    label: $scope.data.all_catalog_msg,
                    url: '?id=' + $scope.data.sc_category_page + '&catalog_id=-1'
                });
            }
            $scope.data.categories.push({
                label: $scope.data.category.title,
                url: '#'
            });
        }
        $timeout(function() {
            $rootScope.$broadcast('sp.update.breadcrumbs', $scope.data.categories);
        });
        spUtil.setSearchPage('sc');
    }


    var listenerForCatItems = $scope.$on("$sp.service_catelog.show.items_widget", function() {
        $scope.hideItemWidget = false;
    });
    /*=============== Begin link handling ===============*/

    $scope.changeView = function(view) {
        spUtil.setPreference('catalog-item-list-view', view)
        $scope.view = view;
    }

    spUtil.getPreference('catalog-item-list-view', function(value) {
        $scope.view = value || 'card';
    });

    $scope.isTouchDevice = function() {
        return ('ontouchstart' in $window);
    }

    $scope.loadMore = function() {
        $scope.data.new_limit = $scope.data.limit + ($scope.options.limit_item || 9);
        $scope.stopLoader = true;
        $scope.server.update().then(function() {
            var old_limit = $scope.data.limit - ($scope.options.limit_item || 9);
            $scope.data.items[old_limit].highlight = true;
            $scope.stopLoader = true;
        });
    }



    c.closeModal = function() {
        c.modalInstance.close();
    }

    c.openModal = function(item) {
        c.categroy = item.sys_id;
        c.modalInstance = $uibModal.open({
            templateUrl: 'confirmationModal',
            input: item,
            scope: $scope
        });
    }

    c.createRecord = function() {

        c.modalInstance.close();
        c.data.create_crisis = true;
        c.data.selectedCategory = c.categroy;
        c.server.update().then(function() {
            var input = {
                id: 'cir_situation_room',
                sys_id: c.data.created_record,
                table: c.data.tables.SITUATION
            };
            $location.search(input);
        });
    };

    $scope.getItemHREF = function(item) {

        //return "?id=fsm_sc_cat_item";
    }

    var unregister = $rootScope.$on($scope.options.click_event_name, function($event, o) {
        if ("url" in o)
            $location.href = o.url;
        else
            $location.search(o.search);
    });
    var mql;

    if ($window.matchMedia) {
        mql = $window.matchMedia('screen and (max-width: 768px)');
        mql.addListener(handleMatchMedia);
        handleMatchMedia(mql);
    }

    function handleMatchMedia(mql) {
        if (!mql.matches) {
            spUtil.getPreference('catalog-item-list-view', function(value) {
                $scope.view = value || 'card';
                $scope.isMobile = false;
            });
        } else {
            $timeout(function() {
                $scope.view = 'card';
                $scope.isMobile = true;
            })
        }
    }
    $scope.$on("$destroy", function() {
        unregister();
        listenerForCatItems();
        if (mql)
            mql.removeListener(handleMatchMedia);
    });

    $scope.startItemList = function() {
        $scope.stopLoader = true;
    }
    /*=============== End link handling ===============*/

    // Added a rootscope to see if the user inserts a location, and show the global items for that category
    if (!$scope.data.showPanel) {
        $rootScope.$on('chooseLocation', function(event, location) {
            $scope.data.showPanel = true;
        });
    }


    $rootScope.$on('showCategories', function(event, selectedCategory) {
        c.data.selectedCategory = selectedCategory;
        c.server.update();
    });
}]]></client_script>
        <controller_as>c</controller_as>
        <css>.toggle {&#13;
  color: $dropdown-link-disabled-color;&#13;
  i:not(.active):hover {&#13;
	  color: $list-group-link-heading-color;&#13;
  }&#13;
}&#13;
&#13;
.fa.active {&#13;
  color: $primary-color;&#13;
}&#13;
&#13;
.item-table {&#13;
  background-color: #fff;&#13;
   tr {&#13;
     th {&#13;
       padding: 16px 10px;&#13;
     }&#13;
     td {&#13;
       padding: 16px 10px;&#13;
       border: none;&#13;
     }&#13;
   }&#13;
}&#13;
&#13;
.btn-loadmore {&#13;
    margin-left: auto;&#13;
    margin-right: auto;&#13;
    display: block;&#13;
    margin-bottom: 20px;&#13;
}&#13;
</css>
        <data_table>sp_instance</data_table>
        <demo_data/>
        <description/>
        <docs/>
        <field_list/>
        <has_preview>false</has_preview>
        <id>cir-categories-from-tree</id>
        <internal>false</internal>
        <link><![CDATA[function link(scope, element, attrs, controller) {
  
}]]></link>
        <name>CIR Situation Categories From Tree</name>
        <option_schema/>
        <public>false</public>
        <roles>x_fru_cir.situation_manager,x_fru_cir.situation_initiator</roles>
        <script><![CDATA[(function() {

	data.tables = CIRConstants.Tables;
    data.show_popular_item = true;
    data.show_more = true;
    data.limit = options.limit_item || 9;
    data.more_msg = gs.getMessage("CIR NEEDS TO BE CHANGED Showing {0} items", data.limit);
    data.items = [];
    data.selectedCategory = input ? input.selectedCategory : '';
    data.create_crisis = input ? input.create_crisis : false;

    if (data.create_crisis) {
        data.created_record = createCrisis(data.selectedCategory);
    }

    if (!data.selectedCategory) {
        data.show_more = false;
        return;
    }

    if (input && input.new_limit)
        data.limit = input.new_limit;

    if (input && input.startWindow) {
        data.endWindow = input.endWindow;
    } else {
        data.startWindow = 0;
        data.endWindow = 0;
    }

    data.startWindow = data.endWindow;
    data.endWindow = data.endWindow + data.limit;
    data.items = queryItems(data.startWindow, data.endWindow, data.selectedCategory);

    if (data.items.length < data.limit) {
        data.show_more = false;
    }

    var numbers = Math.round(data.limit);
    if (data.items.indexOf(data.placeholderItem)) {
        numbers = numbers - 1;
    }


    function queryItems(startWindow, endWindow, dimension) {

        var items = [];
        var query = 'active=true';
        query += dimension ? '^dimension=' + dimension : '';

        var grCatgeories = new GlideRecordSecure(data.tables.SITUATION_CATEGORY);
        grCatgeories.addEncodedQuery(query);
        grCatgeories.chooseWindow(startWindow, endWindow);
        grCatgeories.query();

        while (grCatgeories.next()) {
            items.push(fetchItemDetails(grCatgeories));
        }

        return items;
    }


    function fetchItemDetails(itemRecord) {

        var item = {};
        item.name = itemRecord.name.toString();
        item.short_description = itemRecord.description + '';
        item.picture = itemRecord.icon ? itemRecord.icon.toString() + '.iix' : '';
        item.sys_id = itemRecord.getUniqueValue().toString();

        return item;
    }

    function createCrisis(category) {
        var grCrisis = new GlideRecordSecure(data.tables.SITUATION);
        grCrisis.initialize();
        grCrisis.category = category;
        grCrisis.dimension = getCategoryDim(category);
        var country = new CIRSituationUtils().GetCountryID();
        grCrisis.setValue("country", country);   
        return grCrisis.insert();
    }
	
	function getCategoryDim(categoryId){
		var grCat = new GlideRecordSecure(data.tables.SITUATION_CATEGORY);
		if(grCat.get(categoryId)){
			return grCat.getValue('dimension');
		}
		
	}

})();]]></script>
        <servicenow>false</servicenow>
        <sys_class_name>sp_widget</sys_class_name>
        <sys_created_by>hugo.reis</sys_created_by>
        <sys_created_on>2020-06-22 09:51:46</sys_created_on>
        <sys_id>3f24e0b5dba15810bf9ead8ed3961959</sys_id>
        <sys_mod_count>7</sys_mod_count>
        <sys_name>CIR Situation Categories From Tree</sys_name>
        <sys_package display_value="Corporate Incident Response" source="x_fru_cir">265c101f13ab44100b8670a76144b0a2</sys_package>
        <sys_policy/>
        <sys_scope display_value="Corporate Incident Response">265c101f13ab44100b8670a76144b0a2</sys_scope>
        <sys_update_name>sp_widget_3f24e0b5dba15810bf9ead8ed3961959</sys_update_name>
        <sys_updated_by>Paulo.Gomes@fruitionpartners.pt</sys_updated_by>
        <sys_updated_on>2020-07-15 16:36:39</sys_updated_on>
        <template><![CDATA[<div ng-if="!data.create_crisis" class="m-t-sm ">
    <h4 ng-if="data.error">{{data.error}}</h4>
    <div ng-init="spSearch.targetCatalog()">
        <div class="row">
            <div class="col-xs-9">

                <h1 class="h4 m-t-none break-word" aria-label="{{data.category}} ${Category}">${cir_sit_categories}</h1>
                <p class="hidden-xs break-word">
                   
                </p>
            </div>
            <div class="col-xs-3">
                <div class="pull-right padder-t-sm text-lg toggle" ng-show="!data.error && data.items.length > 0">
                    <i class="fa fa-th" ng-click="changeView('card')" aria-label="${Card View}" ng-class="{'active' : view == 'card'}" uib-tooltip="${Card View}" tooltip-placement="top" tooltip-enable="!isTouchDevice()" tooltip-append-to-body="true" aria-label="${Card View}" tabindex="0"></i>
                    <span class="m-l-sm m-r-sm "> | </span>
                    <i class="fa fa-list-ul" ng-click="changeView('grid')" aria-label="${Grid View}" ng-class="{'active' : view == 'grid'}" uib-tooltip="${Grid View}" tooltip-placement="top" tooltip-enable="!isTouchDevice()" tooltip-append-to-body="true" aria-label="${Grid View}" tabindex="0"></i>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-sm-6 col-md-4" ng-if="!data.items.length">
                ${cir_sit_no_items}
              
          </div>
            <table class="table table-striped item-table" ng-if="view == 'grid' && data.items.length > 0">
                <thead>
                <tr>
                    <th>${cir_sit_categories}</th>
                    <th>${cir_sit_description}</th>
                </tr>
                </thead>
                <tbody>
                <tr ng-repeat="item in data.items | orderBy: 'order' | limitTo: data.limit track by item.sys_id"
                    ng-click="c.openModal(item)"
                    ng-init="startItemList()"
                    ng-if= "item.sys_id != data.placeholderItem">
                    <td>
                        <img ng-src="{{::item.picture}}?t=small" ng-if="item.picture" alt="{{::item.name}}" class="m-r-sm m-b-sm item-image pull-left"/>
                        <div class="break-word">
                            <a target="{{::item.target}}" href="javascript:;" sn-focus="{{::item.highlight}}"> {{::item.name}}<span ng-if="item.content_type == 'external'" aria-label="${External Link}"> ➚</span> </a>
                        </div>
                    </td>
                    <td class="break-word">{{::item.short_description}}</td>
                </tr>
                </tbody>
            </table>
            <div ng-if="view == 'card'">
                <div class="col-sm-6 col-md-4"
                     ng-repeat="item in data.items | orderBy: 'order' | limitTo: data.limit track by item.sys_id"
                     ng-init="startItemList()"
                     ng-if= "item.sys_id != data.placeholderItem">
                    <div class="panel panel-{{::options.color}} b">
                        <a target="{{::item.target}}" href="javascript:;" ng-click="c.openModal(item)" class="panel-body block" sn-focus="{{::item.highlight}}">
                            <div class="overflow-100">
                                <h2 class="h4 m-t-none m-b-xs text-overflow-ellipsis" title="{{::item.name}}" style="padding-bottom:1px">{{::item.name}}<span ng-if="item.content_type == 'external'" aria-label="${External Link}"> ➚</span></h2>
                                <img ng-src="{{::item.picture}}?t=small" ng-if="item.picture" alt="{{::item.name}}" class="m-r-sm m-b-sm item-image pull-left" />
                                <div class="text-muted item-short-desc break-word">{{::item.short_description}}</div>
                            </div>
                        </a>
                        <div aria-hidden="true" class="panel-footer">
                            
                            <a aria-hidden="true"  ng-click="c.openModal(item)"  href='' target="_blank" class="pull-left text-muted" tabindex="-1">${Create}</a>
                            <span ng-if="data.showPrices && item.hasPrice" class="pull-right item-price font-bold">{{::item.price}}</span> &nbsp;
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="text-a-c" ng-if="!stopLoader && data.items.length > 0 && !data.error">
            <i class="fa fa-spinner fa-pulse fa-3x fa-fw"></i>
            <span class="sr-only">${Loading...}</span>
        </div>
        <div ng-if="data.show_more && !show_popular_item">
          <!--  <div class="text-a-c">
                {{data.more_msg}}
            </div>-->
            <button class="m-t-xs btn btn-default btn-loadmore" ng-click="loadMore()">
                ${cir_sit_show_more}
            </button>
        </div>
    </div>
</div>
<script type="text/ng-template" id="confirmationModal">
	<div class="panel panel-default">
		<div class="panel-heading">
			<h4 class="panel-title">${cir_sit_situation_confirmation_title}</h4>
  		</div>
		<div class="panel-body wrapper-xl">
			<h4>${cir_sit_situation_confirmation_message}</h4>
  		</div>
		<div class="panel-footer text-right">
    		<button class="btn btn-default" ng-click="c.closeModal()">${cir_sit_cancel}</button>
			<button class="btn btn-primary" ng-click="c.createRecord()">${cir_sit_yes}</button>
		</div>
	</div>
</script>
]]></template>
    </sp_widget>
</record_update>
